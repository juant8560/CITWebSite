---
import Layout from '../../layouts/Layout.astro';
import HeroFooter from '../../components/shared/HeroFooter.astro';
import { CaseStudiesContentService } from '../../services/CaseStudiesService';
import { CommonContentService } from '../../services/CommonContentService';

const locale = Astro.url.searchParams.get('lang') || 'es';
const isEN = locale === 'en';

const hero = await CaseStudiesContentService.getHeroContent(locale);
const categories = await CaseStudiesContentService.getCaseStudiesCategory(locale);
const caseStudies = await CaseStudiesContentService.getCaseStudies(locale);
const footerHero = await CommonContentService.getHeroFooterContent(locale);
const footer = await CommonContentService.getFooterContent();
---

<Layout title="CIT - Case Studies" footerContent={footer} locale={locale}>
  <!-- Hero -->
  <section class="cs-hero" style={`background-image: url(${hero?.backgroundImage})`}>
    <div class="hero-overlay">
      <h1 class="heading-large">{isEN ? (hero?.titleEN || hero?.titleES) : (hero?.titleES || hero?.titleEN)}</h1>
      <p class="text-small">{isEN ? (hero?.captionEN || hero?.captionES) : (hero?.captionES || hero?.captionEN)}</p>
    </div>
  </section>

  <!-- Case Studies List -->
  <section class="cs-list-section scroll-reveal">
    <!-- Categories filter -->
    <div class="categories" id="categories">
      <button class="cat-btn active" data-cat="all">{isEN ? 'All' : 'Todos'}</button>
      {categories.map((cat: any) => (
        <button class="cat-btn" data-cat={cat.id}>{isEN ? (cat.nameEN || cat.nameES) : (cat.nameES || cat.nameEN)}</button>
      ))}
    </div>

    <!-- Case studies grid -->
    <div class="cs-grid" id="cs-grid">
      {caseStudies.map((cs: any) => (
        <a href={`/caseStudies/${cs.id}${isEN ? '?lang=en' : ''}`} class="cs-card" data-categories={JSON.stringify(cs.idCategories)}>
          <div class="cs-image">
            <img src={cs.picture} alt={isEN ? (cs.titleEN || cs.titleES || cs.name) : (cs.titleES || cs.titleEN || cs.name)} loading="lazy" />
          </div>
          <div class="cs-info">
            <h3 class="heading-small">{isEN ? (cs.titleEN || cs.titleES || cs.name) : (cs.titleES || cs.titleEN || cs.name)}</h3>
            <p class="text-tiny">{(isEN ? (cs.descriptionEN || cs.descriptionES || '') : (cs.descriptionES || cs.descriptionEN || '')).substring(0, 100)}</p>
          </div>
        </a>
      ))}
    </div>
  </section>

  <HeroFooter content={footerHero} locale={locale} />
</Layout>

<script>
  const catBtns = document.querySelectorAll('.cat-btn');
  const cards = document.querySelectorAll('.cs-card');

  catBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      catBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const cat = btn.getAttribute('data-cat');

      cards.forEach(card => {
        if (cat === 'all') {
          (card as HTMLElement).style.display = 'flex';
        } else {
          const cats = JSON.parse(card.getAttribute('data-categories') || '[]');
          (card as HTMLElement).style.display = cats.includes(Number(cat)) ? 'flex' : 'none';
        }
      });
    });
  });
</script>

<style lang="scss">
  @use '../../styles/variables.scss' as *;

  .cs-hero {
    position: relative; width: 100%; height: 50vh; min-height: 35rem;
    background-size: cover; background-position: center; text-align: center;
  }
  .hero-overlay {
    position: absolute; top: 0; bottom: 0; left: 0; right: 0;
    background: rgba($primaryBackgroundColor, 0.85);
    display: grid; place-content: center; gap: 1.5rem; padding: 2rem;
    h1 { color: $primaryTextColor; } p { color: $secondaryTextColor; max-width: 60rem; margin: 0 auto; }
  }

  .cs-list-section { background-color: $primaryBackgroundColor; padding: 6rem 3.7rem; }

  .categories {
    display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-bottom: 4rem;
  }
  .cat-btn {
    background: $thirdBackgroundColor; color: $primaryTextColor; border: none;
    padding: 0.8rem 2rem; border-radius: 5px; cursor: pointer;
    font-family: $mainFont; font-size: 1.4rem;
    transition: all 0.3s;
    &:hover, &.active { background: $thirdColor; }
  }

  .cs-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 3rem;
    justify-content: center;
    max-width: 120rem;
    margin: 0 auto;
  }
  .cs-card {
    background: $secondBackgroundColor; border-radius: 1rem; overflow: hidden;
    transition: transform 0.3s;
    display: flex; flex-direction: column;
    width: 100%; max-width: 35rem;
    padding-bottom: 0;
    background-image: none;
    background-size: 0;
    text-decoration: none;
    &:hover { transform: translateY(-0.5rem); background-size: 0; }
  }
  .cs-image { aspect-ratio: 16/9; overflow: hidden; img { width: 100%; height: 100%; object-fit: cover; } }
  .cs-info { padding: 2rem; h3 { color: $primaryTextColor; margin-bottom: 0.8rem; } p { color: $secondaryTextColor; } }
</style>
